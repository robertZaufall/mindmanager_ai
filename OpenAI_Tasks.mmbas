'#Language "WWB-COM"
'#Uses "GptRequest.cls"
'#Uses "Settings.cls"

Option Explicit

Sub Main()
	Dim Settings As New Settings
    Dim GptRequest As New GptRequest

	Dim doc As Document
	Dim Selection As Object
	Dim SelectedTopic As Object
	Dim Parent As Object
	Dim CentralTopic As Topic
	Dim FirstLevelTopics As Object
	Dim Topics() As String
    Dim node As String
	Dim level As Integer
	Dim context As String
	Dim ThisTopic As Object

	Set doc = ActiveDocument
	Set Selection = doc.Selection
	Set SelectedTopic = Selection.PrimaryTopic

    If SelectedTopic Is Nothing Then
        MsgBox "Please select a topic first.", vbExclamation
        Exit Sub
    End If

	level = SelectedTopic.Level

	If level > 0 Then
		Set ThisTopic = SelectedTopic
    	Set Parent = ThisTopic.ParentTopic
		While Not Parent Is Nothing
	    	context = Parent.Text + "|" + context
	    	Set Parent = Parent.ParentTopic
		Wend
    End If

    Set CentralTopic = doc.CentralTopic
    Set FirstLevelTopics = CentralTopic.SubTopics

    Dim strSystem As String
    Dim strUser As String
	strSystem = "You are a helpful assistant."
	strUser = "Refine the following mindmap topic (which has parent topics as context delimited by '|') by generating " + _
		"top " + Settings.TopMostResults + " most important short bullet points, " + _
		"each " + Settings.MaxReturnWords + " words at maximum and delimited by '#': " + "'" & context + SelectedTopic.Text & "'"

	If Settings.SwDebug Then MsgBox(strUser)

	Settings.MaxTokens = Settings.MaxTokensSimple
	Dim contentSTring As String
	contentSTring = GptRequest.Gpt4Request(Settings, strSystem, strUser)
    Topics = Split(contentSTring, "#")

    For Each node In Topics
    	If node <> "" Then
        	SelectedTopic.AddSubTopic Trim(node)
        End If
    Next node
End Sub
